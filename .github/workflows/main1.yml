name: DoktaSend App CI/CD

on:
  push:
    branches:
      - main  # Keeping your original branch name

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: dokta-team/doktasend-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Setup SSH for server deployment
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 3. Deploy to VPS Server (NO DOCKER - GIT PULL + PM2)
      - name: Deploy to the VPS Server
        run: |
          ssh -o StrictHostKeyChecking=accept-new ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            cd apps/doktasend-app

            echo "Pulling latest code ðŸ“¥â¬‡ï¸ ....."
            git pull origin main

            echo "Installing dependencies ðŸ“¦..."
            npm install

            echo "Building application ðŸ—ï¸..."
            npm run build

            echo "Restarting PM2 ðŸ”„..."
            pm2 restart doktasend-app || pm2 start npm --name "doktasend-app" -- start

            echo "âœ… Deployment completed successfully!"
            echo "ðŸ“Š Checking service status..."
            pm2 status

            echo "ðŸ§¹ Cleaning up old files..."
            npm cache clean --force
          EOF