name: DoktaSend App CI/CD

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: dokta-team/doktasend-app
  API_VERSION: 1.0.2

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Log in to GHCR
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      # 3Ô∏è‚É£ Build & Push Docker image (versioned + latest)
      - name: Build and push Docker image
        run: |
          BRANCH_NAME=${GITHUB_REF##*/}
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          VERSION_TAG="${BRANCH_NAME}-${SHORT_SHA}"
          API_VERSION=1.0.2
          echo "Building version tag: $VERSION_TAG"

          docker build --no-cache -t ghcr.io/${{ env.IMAGE_NAME }}:${{ env.API_VERSION }} \
             -t ghcr.io/${{ env.IMAGE_NAME }}:latest .

          docker push ghcr.io/${{ env.IMAGE_NAME }}:${{ env.API_VERSION }}
          # docker push ghcr.io/${{ env.IMAGE_NAME }}:latest

          # Save VERSION_TAG for deployment
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
          echo "API_VERSION=${{ env.API_VERSION }}" >> $GITHUB_ENV
          echo "IMAGE_FULL_TAG=ghcr.io/${{ env.IMAGE_NAME }}:${{ env.API_VERSION }}" >> $GITHUB_ENV

          

      # 4Ô∏è‚É£ Setup SSH for server deployment
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 5Ô∏è‚É£ Deploy latest image on server
      - name: Deploy to the VPS Server
        run: |
          ssh -o StrictHostKeyChecking=accept-new ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            cd apps/frontend/doktasend-app

            export API_VERSION=${{ env.API_VERSION }}
        
            echo "=== DEPLOYING VERSION: ${{ env.API_VERSION }} ==="

            echo "Logging in to GHCR üîëüì¶ ...."
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ secrets.GHCR_USERNAME }} --password-stdin

            API_VERSION=${{ env.API_VERSION }} docker compose --env-file .env.local down --remove-orphans
            # Pull the latest image for doktasend-app
            API_VERSION=${{ env.API_VERSION }}docker compose --env-file .env.local pull doktasend-app

            # Recreate only the frontend container and remove orphans
            # docker compose --env-file .env.local up -d \
            #   --no-deps --force-recreate --remove-orphans doktasend-app
            API_VERSION=${{ env.API_VERSION }} docker compose --env-file .env.local up -d --no-deps --force-recreate --remove-orphans doktasend-app

            # Wait for container to be ready
            sleep 5

            # Show current container status
            docker compose ps -a

            # Clean dangling images
            docker image prune -f --filter "dangling=true"

            # Optional: Remove old tagged images except latest/current
            # docker images ghcr.io/dokta-team/doktasend-app --format "{{.Repository}}:{{.Tag}}" \
            #   | grep -v "${{ env.API_VERSION }}" \
            #   | grep -v "latest" \
            #   | xargs -r docker rmi -f

            echo "‚úÖ Deployment complete!"
          EOF
