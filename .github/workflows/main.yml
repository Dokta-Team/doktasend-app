name: DoktaSend App CI/CD

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: dokta-team/doktasend-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Log in to GHCR
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      # 3Ô∏è‚É£ Build & Push Docker image (versioned + latest)
      - name: Build and push Docker image
        run: |
          BRANCH_NAME=${GITHUB_REF##*/}
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          VERSION_TAG="${BRANCH_NAME}-${SHORT_SHA}"
          echo "Building version tag: $VERSION_TAG"

          docker build --no-cache -t ghcr.io/${{ env.IMAGE_NAME }}:$VERSION_TAG \
             -t ghcr.io/${{ env.IMAGE_NAME }}:latest .

          docker push ghcr.io/${{ env.IMAGE_NAME }}:$VERSION_TAG
          # docker push ghcr.io/${{ env.IMAGE_NAME }}:latest

          # Save VERSION_TAG for deployment
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
          echo "IMAGE_FULL_TAG=ghcr.io/${{ env.IMAGE_NAME }}:$VERSION_TAG" >> $GITHUB_ENV

          

      # 4Ô∏è‚É£ Setup SSH for server deployment
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 5Ô∏è‚É£ Deploy latest image on server
      - name: Deploy to the VPS Server
        run: |
          ssh -o StrictHostKeyChecking=accept-new ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            cd apps/frontend/doktasend-app

            export VERSION_TAG=${{ env.VERSION_TAG }}
        
            echo "=== DEPLOYING VERSION: ${{ env.VERSION_TAG }} ==="

            echo "Logging in to GHCR üîëüì¶ ...."
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ secrets.GHCR_USERNAME }} --password-stdin

            # Pull the latest image for doktasend-app
            VERSION_TAG=${{ env.VERSION_TAG }} docker compose --env-file .env.local pull doktasend-app

            # Recreate only the frontend container and remove orphans
            VERSION_TAG=${{ env.VERSION_TAG }} docker compose --env-file .env.local up -d \
              --no-deps --force-recreate --remove-orphans doktasend-app

            # Wait for container to be ready
            sleep 5

            # Show current container status
            docker compose ps -a

            # Clean dangling images
            docker image prune -f --filter "dangling=true"

            # Optional: Remove old tagged images except latest/current
            docker images ghcr.io/dokta-team/doktasend-app --format "{{.Repository}}:{{.Tag}}" \
              | grep -v "${VERSION_TAG}" \
              | grep -v "latest" \
              | xargs -r docker rmi -f

            echo "‚úÖ Deployment complete!"
          EOF
